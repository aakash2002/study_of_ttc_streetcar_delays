---
title: "Annual Analysis of Delays in TTC Streetcars for the year 2023"
subtitle: "Is there a way to make commuter life easier?"
author: 
  - Aakash Vaithyanathan
thanks: "Code and data are available at: https://github.com/aakash2002/study_of_ttc_streetcar_delays"
date: today
date-format: long
abstract: "This paper aims to study the causes of delays in Toronto Transit Commissions (TTC) streetcar service, the variation in delays by the hours in working shifts and whether there are any seasonal relationships to the observed delays for the year 2023. By using the data provided by OpenData Toronto, we are able to understand the observed relationships between the several fields of interests like minimum delay, hour, season, streetcar line and incident type. Our study finds that there is higher reported delayed times during night shift and higher delays reported during peak hours that fall during the working 9AM - 5PM time period. Interestingly we did not observe any variation in delays during the various seasons and understand that to make stronger inferences between the temporal relationship, we need to examine longer historic data."
format: 
  pdf: 
    fig-pos: "H"
    fig-caption: true
number-sections: true
bibliography: references.bib
link-citations: true
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(ggplot2)
library(gt)

data <- read_csv(here::here("data/analysis_data/cleaned_ttc_streetcar_delay_2023.csv"))

table_styling <- function(gt_tbl) {
  gt_tbl |> 
    cols_label(
      year = "Year",
      month = "Month",
      hour = "Hour",
      incident = "Incident Type",
      min_delay = "Min Delay (minutes)",
      line = "Streetcar Line",
      season = "Season"
    ) |>
    tab_options(
      column_labels.background.color = 'dodgerblue1',
      table_body.hlines.width = px(0) 
    )
  }
```


# Introduction

Toronto Transit Commission (TTC) is the biggest and most used transit authority in Toronto. It was established on September 1, 1921 and since then supports various means of ground transportation like streetcar, shuttle bus and the subway system. Despite being the most used transit system, it does come with several challenges one of the most notable one being the delays experienced between the various stops. One such transportation system we focus on in this paper is streetcars.

These delays make it especially difficult for individuals that commute on a daily basis. Furthermore, one can image the inconveniences caused due to extended delays by streetcars during weather conditions like the winter months. In this paper, we aim to dive deeper into the cause of delays in TTC, how these vary by the times of day and the various seasons and what incidents are the most occurring for the delays experienced. We make use R (@citeR) and the dataset made available by OpenData Toronto (@opendatatoronto) for the year 2023. The reported graphs in our study is generated using ggplot (@ggplot2) and the tables are generated using the gt (@gt) library. Code cleanup is performed using the Janitor (@janitor) package.

The remainder of this paper is structured as follows. We first give a brief overview of the dataset under [datasetdesc] section. Then, we present some graphs on the results extracted from our collected data found under [results] section. Lastly, we conclude with a discussion of our results found under [discussion] section, highlight the limitations in our conducted study found under [limitations] section and propose possible future next steps for this project under [nextsteps] section.

# Dataset Description {#datasetdesc}

## Overview of dataset
The following data was made available from OpenData Toronto (@opendatatoronto) for the year 2023. The data was extracted from the server and saved locally using in a raw data folder. Some of the features part of this dataset are date, time, incident, min delay, bound and location.

## Assumption made in dataset {#assumption}
We observe that our dataset has several rows where the minimum delay time is over 900 minutes or are equal to 0. These values can heavily skew the results that we may observe. Therefore, one key assumption we make in our study is that we limit the maximum delay time to upto 2 hours or 120 minutes. As a result of this filtering, we only lose about 130 data and still retain about 10723 data entries to use in our study.

## Data preprocessing and cleaning
The raw data is undergone a series of data cleaning steps to ensure adequate usability for the study. We first use the Janitor (@janitor) package to clean the data columns removing any spaces between them and using a consistent naming stype for them. Next, we proceed to split the date field into year and month fields and split the time field extracting the hour of day from it. Following this, we create a new column to denote the season based on the month of the year from the data. This helps during the analysis stage when we need to make inferences about the seasonal variation in average delays in streetcars. 

We then proceed to drop the rows with missing values or NA. Out of the total 14413 rows of data, 2399 of them contain NA values in total which doesn't heavily impact our data. Therefore, no transformations are necessary to populate missing entries in our dataset. Lastly, as highlighed in the [assumption] section, we filter our dataset to only include delays of upto 120 minutes.

As a result of the above described data cleaning process, we select our desired features from the dataset. The following table shows the first five rows of our data and the selected features.

```{r}
#| include: true
#| warning: false
#| message: false
#| echo: false

# Create a table highlighting the first five rows and the selected features in the data
limited_row_data <- data |> head(5)

table_features <- gt(limited_row_data)
table_features |> 
  table_styling() |>
  tab_header(
    title = "Selected Features from TTC Streetcar Delay Data"
    ) |>
  tab_style(
    style = cell_text(
      weight = 'bold',
      font = google_font('Merriweather')
    ),
    locations = cells_title(group = 'title')
  ) |>
  tab_style(
    style = cell_fill(color = 'grey90'),
    locations = cells_body(rows = seq(1, nrow(limited_row_data), 2))
  )
cat("Table 1: First first five rows in the cleaned dataset with selected features")
  
```

## Measurement of units for selected features

The following table describes the data types for the selected features in our study from the cleaned dataset.
```{r}
#| include: true
#| warning: false
#| message: false
#| echo: false

# Get feature names
features <- colnames(limited_row_data)

# Get data types for each feature
datatypes <- sapply(limited_row_data, class)

# Combine into a table (data frame)
table <- data.frame(Feature = features, DataType = datatypes)
table_feature_datatypes <- gt(table)
table_feature_datatypes |>
  tab_header(
    title = "Selected Features and their Data Types"
    ) |>
  tab_style(
    style = cell_text(
      weight = 'bold',
      font = google_font('Merriweather')
    ),
    locations = cells_title(group = 'title')
  ) |>
  tab_style(
    style = cell_text(weight = 'bold'),
    locations = cells_column_labels()
  ) |>
  tab_style(
    style = cell_fill(color = 'grey90'),
    locations = cells_body(rows = seq(1, nrow(table), 2))
  )
  cat("Table 2: Datatypes for the selected features from the cleaned dataset.")
```


# Results {#results}
## Average Delay By Streetcar Line
```{r}
#| include: true
#| warning: false
#| message: false
#| echo: false
#| label: fig-delay-by-line
#| fig-cap: Average annual delay in minutes for each streetcar line

# Grouping and summarizing the data
grp_data <- data |> 
  group_by(line) |>
  summarise(average_delay = mean(min_delay), .groups = 'drop')

# Create the bar plot
ggplot(grp_data, aes(x = factor(line), y = average_delay)) +
  geom_bar(stat = "identity", width = 0.7, fill = 'lightblue') +
  geom_text(aes(label = round(average_delay, 2)), 
            vjust = -0.5,  # Position the text above the bar
            size = 2) +  # Adjust the size of the text
  ggtitle("Average delay in minutes by streetcar line") +
  xlab("Streetcar Line") +
  ylab("Average Delay in Minutes") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        title = element_text(hjust = 0.5))

```

@fig-delay-by-line highlights the annual average delay in minutes for every streetcar line for the year 2023. The 300-series lines also called the Blue Network Routes (@ttcRoutesSchedule) are the nighttime streetcar lines that start at 1:30 AM. These buses average the most delays reaching at most 30 minutes for line 312.

The 500-series lines are the daytime lines that run from 8 AM. These buses average between 6 to 23.6 minutes with the longest delay experienced by line 507.

## Average Delays During Dayshift
```{r}
#| label: fig-delay-dayshift
#| fig-cap: Average delay in minutes for dayshift
#| echo: false
#| warning: false
#| message: false

# Filter the data for times between 08:00 and 01:00 i.e day shift
avg_delay_day_shift <- data |> 
  group_by(hour) |>
  summarise(average_delay = mean(min_delay), .groups = 'drop') |>
  filter(hour >= "08" | hour <= "01")

ggplot(avg_delay_day_shift, aes(x = hour, y = average_delay)) +
  geom_line(color = "red", size = 1) +
  geom_point(color = "blue", size = 2) +
  geom_text(aes(label = round(average_delay, 2)), 
            vjust = -1, 
            size = 2) + 
  ggtitle("Average delay in minutes for morning shift") +
  xlab("Hour of Day") +
  ylab("Average Delay (Minutes)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels for clarity
  )
```
@fig-delay-dayshift highlights the annual average delay in minutes experienced by the hour of day for streetcars that run during the day. We observe that there is high variability in the delays throughout the day with the minimum delay being about 13.78 minutes and the maximum being roughly 20 minutes.


## Average Delays During Nightshift
```{r}
#| label: fig-delay-nightshift
#| fig-cap: Average delay in minutes for nightshift
#| echo: false
#| warning: false
#| message: false

# Filter the data for times between 02:00 and 07:00 i.e night shift
avg_delay_night_shift <- data |> 
  group_by(hour) |>
  filter(hour >= "02" & hour <= "07") |>
  summarise(average_delay = mean(min_delay), .groups = 'drop')

# Plot the graph with the reordered x-axis
ggplot(avg_delay_night_shift, aes(x = hour, y = average_delay)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "red", size = 2) +
  geom_text(aes(label = round(average_delay, 2)), 
            vjust = -1, 
            size = 2) + 
  ggtitle("Average delay in minutes for night shift") +
  xlab("Hour of Day") +
  ylab("Average Delay (Minutes)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels for clarity
  )
```
@fig-delay-nightshift highlights the annual average delay in minutes experienced by the hour of day for streetcars that run during the night. We observe that there is decreasing trend in the delays throughout the night after 3 AM with the minimum delay being about 14 minutes and the maximum roughly 27 minutes.


## Frequency of delays by incidents
```{r}
#| label: fig-freq-delay-incidents
#| fig-cap: Frequency plot for cause of streetcar delay by incidents
#| echo: false
#| warning: false
#| message: false

freq_incidence <- data |> 
  group_by(incident) |> 
  summarise(frequency = n(), .groups = 'drop')

ggplot(freq_incidence, aes(x = incident, y = frequency)) +
  geom_bar(stat = "identity", fill = "lightblue") +
  geom_text(aes(label = frequency), 
            vjust = -0.5,  # Position the text above the bar
            size = 2) +  # Adjust the size of the text
  ggtitle("Frequency of each delay incident in the year 2023") +
  xlab("Delay Incident Type") +
  ylab("Frequency") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),  # Center title
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels for clarity
  )
```
@fig-freq-delay-incidents highlights the total annual delays incurred based on incidents reported by TTC for the reason. We can see for the year of 2023, operation delays were the most frequently occurring including a total of 2463 instances and rail switches were the least occuring with reported instances being only about 20.

## Delay by Seasons
```{r}
#| label: fig-delay-by-season
#| fig-cap: Average delay in minutes by seasons in a yea
#| echo: false
#| warning: false
#| message: false

delay_by_season <- data |>
  group_by(season) |>
  summarise(average_delay = mean(min_delay), .groups = 'drop')

ggplot(delay_by_season, aes(x = season, y = average_delay)) +
  geom_bar(stat = "identity", fill = "lightblue") +
  ggtitle("Average delay in minutes by seasons in a year") +
  xlab("Type of Season") +
  ylab("Average delay in minutes") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),  # Center title
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels for clarity
  )
```

@fig-delay-by-season highlights the annual average delay in minutes based on the seasons. We observe that were isn't as much variation between the streetcar delays between the fall, spring, summer and winter months with each averaging around 16 minutes delay.

# Discussion {#discussion}
The above analysis provide valuable information regarding causes for TTC streetcar delays. Let us take a closer look into each of these.

## Delays by bus lines
The results from @fig-delay-by-line shows that blue network routes (@ttcRoutesSchedule) buses incur the highest average delay. This result makes sense as compared to the day shift buses, there are far fewer night shift buses resulting in fewer drivers for various locations the buses may take. Additionally, we also note that the 900-series streetcar line that go to the Airport incur the longest average delay of almost 54 minutes.

## Average delay for morning shift
The results from @fig-delay-dayshift showcases the variability in average delays by the hour during the morning shift working hours observed between 8 AM to 6 PM. We observe that the results are in-line with the expected behavior of longer average delays of around 18 minutes during peak hours like 8 AM or 5 PM which is usually when a large working population leave and return from work. This can result in higher traffic hours on average causing an expected delay in streetcar arrivals. Additionally, we notice that throughout the day there are several points of interest for peak delays as seen at 11 AM or 1 PM incurring an average delay of 19 minutes. This observation could indicate the need for travel to various locations like grocery stores, perhaps to a friend's house or classes for university students. During these hours, there is heavy traffic and these suggest a potential reason for delays.
 
## Average delay for night shift
The results from @fig-delay-nightshift shows a decreasing trend in the average delays by the hour during the night shift working hours observed between 2 AM to 7 AM. These findings are what we might expect as there is fewer traffic delays during the night resulting in a more consistent decreasing delay pattern. A possible reason for longer delay duration despite fewer traffic could be the fact there there are far fewer blue netwrok routes (@ttcRoutesSchedule) buses that run resulting in fewer drivers that require to cover longer distances. The graph shows that as we get later into the night shift (i.e early morning) we notice the delays dropping as low as roughly 14 minutes.

## Annual frequency of reported delay incidents
The results from @fig-freq-delay-incidents showcase the total count of instances of delays by various incident reports in the year 2023. The above bar graph shows that the most occurring incident was due to operational delays accounting for 2467 total reports. The least occurring incident was Rail switches accounting for only 21 total instance reports in the year.

## Annual delay in minutes by seasons in a year
The results from @fig-delay-by-season show that on average there wasn't as much variability in delays between the various seasons in a year with summer month accounting for the longest reported average delays. Interestingly, the winter month accounted to the least average delays. This result is in-line with the existing literature regarding the weather reports in Canada during the winter season as for the first time in history, Toronto reported an average temperature above -5 degrees throughout the month of December and also reported a warmer winter season overall (@canadaWinterArticle).

## Conclusion
By using the findings from @fig-delay-by-line, and @fig-delay-nightshift, we can conclude that there on average the night shift streetcars showcased the longest average delays with periods between 2 AM to 4 AM having the most delays. These findings support our understanding that there are far fewer night shift buses that operate on average compared to the number of streetcars that operate during the day's regular working hours. @fig-delay-dayshift reports that the day shift streetcars have their reported delays being high during peak hours like 8 AM, 11 AM, 1 PM, 5 PM or 8 PM. These results are in-line with the idea that hours between 9-5 are the general working hours in a day and likely can result in high traffic volumes for individuals and commuters.

In addition to studying the variation in delays by the working shift, their hours of day and by streetcar lines, the study also aims to examine the causes of delays and whether there are any seasonal variations that may attribute to potential delays in TTC streetcars. The findings from @fig-freq-delay-incidents report that during the year 2023, operation delays were the most reported instances of delays of 2467. Furthermore, from @fig-delay-by-season, the study finds that for the year 2023 there weren't as much variability in average delays of streetcars between the seasons. This result makes sense as during the winter season due to the harsh weather conditions, there is expected operational delays between streetcar arrivals as seen by the article in 2015 that shows that 25 streetcars were knocked off route (@streetcarOffRoute).

The results from our study highlight important considerations on the types of delay incidents that occur in streetcars, what time of day between various working shifts are there highest reported delays and whether season has any impact on the cause of delays. By examining these results, we hope to be able to allocate improved resources to address the various reported incidents for delays. To address the issue of delays during peak hours, a potential solution might be to employ additional streetcars that run during these hours and by investing more resources in the night shift streetcars the workload and reduce long delays during late hours like 2-4 AM as these hours are usually dangerous to be out especially alone.

# Limitations

Despite being able to extract several key insights as mentioned in the [discussion] section, our study does have certain limitations that need to be addressed as part of next steps.

One of the key limitation is due to the consequence of our dataset. It is important to highlight that the results and inferences made part of this study are for the year 2023 and cannot be generalized to the overall trend in delay patterns that we may observe. The results from @fig-delay-by-season is one such example as the result will likely have strong correlation to the observed weather data for the specific year. During the year 2023, Toronto reported a unusually warmer time resulting in less frequent and intense snowfall thus not negatively impacting streetcar track or traffic significantly. It is important to note that in order to make stronger inferences from our data, we need to extend our dataset to account for past year's of TTC delay data collected from OpenData Toronto.

Another limitation is relating to the quality of the data that we may have. Every year TTC reports its Annual Service Plan (@ttc2024Annual) which highlights the track maintenance works and re-routes that may occur during the summer and fall months. As part of this, many routes are completely closed down and as such they switch over to alternative modes of transportation like using shuttle buses. When collecting data from various years, it is important to make sure that any lack of available data is mentioned in our study as data for these maintenance months may be missing.

# Next Steps {#nextsteps}

In terms of the next steps, there are 2 ways we could extend our study to improve the findings from it.

The first is by addressing the above mentioned limitation of combining data from various years to provide a more richer quality of identified results. By combining the data from past years, we are better able to learn of any temporal trends in the data which can lead to interesting results.

The second way to improve our study is by making use of available streetcar delay sentiment data to understand the recurring pain points and emotions that are expressed by commuters. This data when combined with existing streetcar delay data can provide richer contextual information about the types of incident delays and the sentiment expressed. Another interesting result we can hope to learn is how these sentiments vary between various seasons as during harsher seasons like summer and winter, one can imagine that it wouldn't be most pleasant to experience a long delay in streetcar arrivals. 

These findings can help to better connect with the population and provide valuable information on how to better modify or establish new policies that can help to improve the overall commuting experience for the residents of Toronto, the city they call home.

\newpage

# References
